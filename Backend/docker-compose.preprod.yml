version: '3.8'

services:
  # Cardano Node (Preprod Testnet)
  cardano-node-preprod:
    image: ghcr.io/intersectmbo/cardano-node:latest
    platform: linux/amd64
    container_name: cardano-preprod-node
    environment:
      NETWORK: preprod
    ports:
      - "3001:3001"
    volumes:
      - cardano-preprod-data:/data
      - cardano-preprod-ipc:/ipc
    # command: run
    networks:
      - cardano-preprod
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cardano-cli query tip --testnet-magic 1 --socket-path /ipc/node.socket || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s

  # Ogmios - Cardano node interface for preprod
  ogmios-preprod:
    image: cardanosolutions/ogmios:latest
    platform: linux/amd64
    container_name: ogmios-preprod
    depends_on:
      cardano-node-preprod:
        condition: service_healthy
    ports:
      - "1337:1337"
    volumes:
      - cardano-preprod-ipc:/ipc
      - ./config/preprod:/config
    command:
      - --node-socket
      - /ipc/node.socket
      - --node-config
      - /config/config.json
      - --host
      - 0.0.0.0
      - --port
      - "1337"
    networks:
      - cardano-preprod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:1337/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Kupo - Cardano chain indexer for preprod
  kupo-preprod:
    image: cardanosolutions/kupo:latest
    platform: linux/amd64
    container_name: kupo-preprod
    depends_on:
      cardano-node-preprod:
        condition: service_healthy
    ports:
      - "1442:1442"
    volumes:
      - cardano-preprod-ipc:/ipc
      - kupo-preprod-data:/db
      - ./config/preprod:/config
    command:
      - --node-socket
      - /ipc/node.socket
      - --node-config
      - /config/config.json
      - --host
      - 0.0.0.0
      - --port
      - "1442"
      - --since
      - origin
      - --match
      - "*"
      - --workdir
      - /db
    networks:
      - cardano-preprod
    restart: unless-stopped

  # Hydra Node for Preprod
  hydra-node-preprod:
    image: ghcr.io/cardano-scaling/hydra-node:latest
    platform: linux/amd64
    container_name: hydra-preprod
    depends_on:
      cardano-node-preprod:
        condition: service_healthy
    ports:
      - "4001:4001"  # API
      - "5001:5001"  # P2P
    volumes:
      - cardano-preprod-ipc:/ipc
      - hydra-preprod-data:/data
      - ./wallets/preprod/hydra:/keys:ro
    command:
      - --node-id
      - "314"
      - --api-host
      - "0.0.0.0"
      - --listen
      - "0.0.0.0:5001"
      - --advertise
      - "localhost:5001"
      - --monitoring-port
      - "6001"
      - --hydra-signing-key
      - "/keys/hydra.sk"
      - --cardano-signing-key
      - "/keys/cardano.sk"
      - --testnet-magic
      - "1"
      - --hydra-scripts-tx-id
      - "${HYDRA_SCRIPTS_TX_ID}"
      - --ledger-protocol-parameters
      - "/keys/protocol-parameters.json"
      - --node-socket
      - "/ipc/node.socket"
      - --persistence-dir
      - "/data"
    networks:
      - cardano-preprod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL for data storage
  postgres-preprod:
    image: timescale/timescaledb:latest-pg15
    container_name: postgres-preprod
    environment:
      POSTGRES_DB: cardano_preprod
      POSTGRES_USER: cardano
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
    ports:
      - "5433:5432"
    volumes:
      - postgres-preprod-data:/var/lib/postgresql/data
    networks:
      - cardano-preprod
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cardano -d cardano_preprod"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  cardano-preprod-data:
    driver: local
  cardano-preprod-ipc:
    driver: local
  kupo-preprod-data:
    driver: local
  hydra-preprod-data:
    driver: local
  postgres-preprod-data:
    driver: local

networks:
  cardano-preprod:
    driver: bridge
